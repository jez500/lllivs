name: laravel-project
recipe: lagoon

# Basic config.
config:
  flavor: laravel
  build:
    - composer install
  env_file:
    - .env

# Additional lando commands.
tooling:
  build:
    service: cli
    description: Run composer install and npm build
    cmd:
      - composer install
      - npm rebuild node-sass
      - npm install
      - npm run prod
  npm:
    service: cli
    description: Runs a npm command
  artisan:
    service: cli
    description: Run a artisan command
    cmd: php artisan
  clear:
    service: cli
    description: Clear all local caches and configs
    cmd:
      - rm bootstrap/cache/*.php
      - php artisan optimize:clear
      - php artisan config:clear
      - php artisan cache:clear
      - composer dump-autoload
  watch:
    service: cli
    description: watches changes to theme and recompile
    cmd:
      - npm run watch
  prepare-storage:
    service: cli
    description: Ensure storage dirs are all setup correctly (only run once after fresh clone)
    cmd:
      - mkdir -p storage/framework/{sessions,views}
      - mkdir -p storage/framework/cache/data
      - mkdir -p storage/app/public
      - mkdir -p storage/logs
      - chmod -R 777 /home/.composer
      - ln -s ../storage/app/public public/storage
      - echo "Done, set permissions with 'sudo chmod +w -R storage'"
  xdebug-on:
    description: Enable xdebug for php.
    cmd:
      - php: cp /app/lagoon/docker-php-ext-xdebug.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && pkill -USR2 php-fpm || true
      - cli: cp /app/lagoon/docker-php-ext-xdebug.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && pkill -USR2 php-fpm || true
    user: root
  xdebug-off:
    description: Disable xdebug for php.
    cmd:
      - php: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && pkill -USR2 php-fpm || true
      - cli: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && pkill -USR2 php-fpm || true
    user: root

# Additional services that get started with the project.
services:
  cli:
    overrides:
      ports:
        - 3000:3000 # If this gets changed (due to port conflict, also change in .env)
  phpmyadmin:
    type: phpmyadmin
    hosts:
      - mariadb
    overrides:
      environment:
        PMA_USER: lagoon
        PMA_PASSWORD: lagoon
  mailhog:
    type: mailhog
    portforward: true
    hogfrom:
      - php

# Routes to access additional services.
proxy:
  mailhog:
    - mail.laravel-project.lndo.site
  phpmyadmin:
    - pma.laravel-project.lndo.site
